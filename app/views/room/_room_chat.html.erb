<% unless actual_room.nil? %>
    <% is_owner = current_user.has_status('owner', actual_room) %>
    <% is_player = current_user.has_status('player', actual_room) %>
    <% is_global_chat = actual_room.id == 1 %>
    <div id="<%= actual_room.id %>" class="actual_room">
      <h3><%= actual_room.name %></h3>

      <div id="messsages">
        <% actual_room.messages.reverse.each do |f| %>
            <%= render partial: 'message/message', locals: {message: f} %>
        <% end %>
      </div>
      <br>
      <div class="row">
        <div class="col-lg-9 col-md-9 col-sm-9" style="background-color: #99b058">
          <% if is_owner || is_player || is_global_chat %>
              Sprava:<br>
              <textarea name="message[body]" id="message_body"></textarea>
              <button id="send">Po≈°li</button>
          <% end %>
        </div>
        <% if actual_room.id != 1 %>
            <div class="col-lg-3 col-md-3 col-sm-3" style="background-color: #b87186">
              <% if is_owner %>
                  <button onclick="renderManagePplOverlay()">Manage ppl</button>
              <% end %>
              <div class="popup_container">
                <button onclick="toggleLocationPopup()">Show location</button>
                <div class="location_popup">
                  <% if actual_room.location.nil? %>
                      <h4 align="center">No location</h4>
                      <p></p>
                  <% else %>
                      <h4 align="center"><%= actual_room.location.name %></h4>
                      <p><%= actual_room.location.description %></p>
                  <% end %>
                  <% if is_owner || is_player %>
                      <button onclick="renderManageLocationOverlay()">Choose new location</button>
                  <% end %>
                </div>
              </div>
              <% if is_player || is_owner %>
                  <button>Export game</button>
                  <button>End game</button>
              <% end %>
              <% if is_player %>
                  <button>Leave game</button>
              <% end %>
            </div>
        <% end %>
      </div>
    </div>
    <br>

    <script>

        var shiftPressed = false;

        $("#send").click(sendMessage);

        $("#message_body").keydown(function (e) {
            console.log(e.which);
           if(e.which == 16){
               shiftPressed = true;
           }
        });

        $("#message_body").keyup(function (e) {
            if(e.which == 16){
                shiftPressed = false;
            }
            if(e.which == 13 && !shiftPressed) {
                sendMessage();
            }
        });

        function sendMessage() {
            var body = $("#message_body").val();
            var room = $(".actual_room")[0].id;
            var message = {
                body: body,
                user: '',
                room: room,
                id: '',
                time: '',
                fullname: '',
                imgpath: '',
            };

            if (body.trim()) {
                console.log('Sending: ' + body);
                dispatcher.trigger('messages.create', message);
                $("#message_body").val('');
            }
        }

        function renderManagePplOverlay() {
            $.ajax({
                type: 'GET',
                url: '<%= miestnosti_ppl_path %>/<%= actual_room.id %>'
            });
        }

        function renderManageLocationOverlay() {
            $.ajax({
                type: 'GET',
                url: '/available_locations/<%= actual_room.id %>'
            })
        }

        function toggleLocationPopup() {
            $('.location_popup')[0].classList.toggle("show");
        }
    </script>

<% end %>